name: 1.0.0$(Rev:.r)

resources:
- repo: self

pool:
  name: Hosted VS2017

trigger:
  branches:
    include:
    - master
  paths:
    exclude:
    - README.md

pr:
  paths:
    exclude:
    - README.md

variables:
  BuildPlatform: 'any cpu'
  BuildConfiguration: 'release'
  Solution: '**\*.sln'

steps:

- powershell: |
   $path = $path = "$(System.DefaultWorkingDirectory)/Solutions/packageSolution/Other/Solution.xml"
   [XML]$xml = Get-Content $path
   $solutionversion = $xml.ImportExportXml.SolutionManifest.Version
   Write-Host "##vso[build.updatebuildnumber]$solutionversion"
  displayName: 'Set Build Number from D365 Solution'
    

- task: NuGetToolInstaller@0
  displayName: 'Use NuGet 4.4.1'
  inputs:
    versionSpec: 4.4.1

- task: NuGetCommand@2
  displayName: 'NuGet restore'
  inputs:
    restoreSolution: '$(Solution)'

   
- task: VSBuild@1
  displayName: 'Build Solution'
  inputs:
    solution: '$(Solution)'
    vsVersion: 15.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactstagingdirectory)\\"'

- task: PowerShell@2
  displayName: 'Pack Solution'
  inputs:
    targetType: filePath
    filePath: 'Solutions/Scripts/SolutionPack.ps1'

- task: CopyFiles@2
  displayName: 'Copy Reference Data to: $(build.artifactstagingdirectory)'
  inputs:
    SourceFolder: Solutions
    Contents: '*.zip'
    TargetFolder: '$(build.artifactstagingdirectory)/packages/'

- task: CopyFiles@2
  displayName: 'Copy Reference Data to: $(build.artifactstagingdirectory)'
  inputs:
    SourceFolder: Solutions/ReferenceData
    Contents: '*.xml'
    TargetFolder: '$(build.artifactstagingdirectory)/data/'

- task: CopyFiles@2
  displayName: 'Copy Build Artifact to: $(build.artifactstagingdirectory)'
  inputs:
    SourceFolder: '$(system.defaultworkingdirectory)'
    Contents: '**\bin\$(BuildConfiguration)\**'
    TargetFolder: '$(build.artifactstagingdirectory)'


- task: PublishSymbols@2
  displayName: 'Publish symbols path'
  inputs:
    SearchPattern: '**\bin\**\*.pdb'
    PublishSymbols: false
  continueOnError: true


- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  inputs:
    PathtoPublish: '$(build.artifactstagingdirectory)'
